<!DOCTYPE html>

<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="socket.html">
                  socket.js
                </a>
              
                
                <a class="source" href="transport-base-transport.html">
                  transport-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-base-transport.html">
                  transport-http-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-longpoll-transport.html">
                  transport-http-longpoll-transport.js
                </a>
              
                
                <a class="source" href="transport-http-server.html">
                  transport-http-server.js
                </a>
              
                
                <a class="source" href="transport-http-stream-transport.html">
                  transport-http-stream-transport.js
                </a>
              
                
                <a class="source" href="transport-websocket-server.html">
                  transport-websocket-server.js
                </a>
              
                
                <a class="source" href="transport-websocket-transport.html">
                  transport-websocket-transport.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
 * Cettia
 * http://cettia.io/projects/cettia-protocol/
 * 
 * Copyright 2015 the original author or authors.
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 */</span>
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">"events"</span>);
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-uuid"</span>);
<span class="hljs-keyword">var</span> msgpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"msgpack-lite"</span>);
<span class="hljs-keyword">var</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">"traverse"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This function is exposed to the module’s <code>createServer</code> as a factory to create a server which
consumes transport and produces socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A server object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>A repository of sockets consisting of opened socket and closed socket only. A socket has id
but it doesn’t need to be public now so that array is used to hide it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.sockets = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Options to configure server and client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> options = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A heartbeat interval in milliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    heartbeat: <span class="hljs-number">20000</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>This is just to speed up heartbeat test and not required generally. It means the time to
wait for the server’s response. The default value is <code>5000</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _heartbeat: <span class="hljs-number">5000</span>
  };
  self.setHeartbeat = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">heartbeat</span>) </span>{
    options.heartbeat = +heartbeat;
  };
  self.set_heartbeat = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">_heartbeat</span>) </span>{
    options._heartbeat = +_heartbeat;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>A link between Cettia protocol and Cettia transport protocol. <code>transport</code> is expected to be
passed from Cettia transport server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.handle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">transport</span>) </span>{
    <span class="hljs-keyword">var</span> socket;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A transport’s URI’s query represents protocol header.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> headers = url.parse(transport.uri, <span class="hljs-literal">true</span>).query;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If it attaches a socket id, looks up a socket whose id is the given id from the repository.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (headers.sid) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; self.sockets.length; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>There may be no matching socket if a socket whose id is the given id was deleted due
to long-term disconnection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (self.sockets[i].id === headers.sid) {
          socket = self.sockets[i];
          <span class="hljs-keyword">break</span>;
        }
      }
    }
    <span class="hljs-keyword">if</span> (!socket) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Creates a socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      socket = createSocket(options);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>If the handshake is performed successfully, adds the socket to the repository and has
it removed when it is deleted. It should be done before giving user a chance to add
their <code>open</code> event handler and only once.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      socket.once(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.sockets.push(socket);
        socket.on(<span class="hljs-string">"delete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>It equals to <code>self.sockets.remove(socket)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self.sockets.splice(self.sockets.indexOf(socket), <span class="hljs-number">1</span>);
        });
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Fires <code>socket</code> event to server to give user a chance to add their event handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.emit(<span class="hljs-string">"socket"</span>, socket);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Performs the handshake by injecting a transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.handshake(transport);
  };
  <span class="hljs-keyword">return</span> self;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSocket</span>(<span class="hljs-params">options</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>A socket object representing the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>As the state of the socket, it can be one of the following values: <code>opened</code>, <code>closed</code> and
<code>deleted</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.state = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>An identifier of the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> id = uuid.v4();</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Exposes it for comparison but it’s not necessary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.id = id;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>A transport associated with the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> transport;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Performs the handshake.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.handshake = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">t</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handshake</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Associates the given transport with the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport = t;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>When an event object is created from <code>text</code> or <code>binary</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onevent</span>(<span class="hljs-params">event</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Event should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: true if this event requires the reply.
If the client sends a plain event, dispatch it.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (!event.reply) {
          self.emit(event.type, event.data);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> latch;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>A function to create a function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reply</span>(<span class="hljs-params">success</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>A controller function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The latch prevents double reply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">if</span> (!latch) {
                latch = <span class="hljs-literal">true</span>;
                self.send(<span class="hljs-string">"reply"</span>, {id: event.id, data: value, exception: !success});
              }
            };
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Here, the controller is passed to the handler as 2nd argument and calls the
server’s <code>resolved</code> or <code>rejected</code> callback by sending <code>reply</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self.emit(event.type, event.data, {resolve: reply(<span class="hljs-literal">true</span>), reject: reply(<span class="hljs-literal">false</span>)});
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>When the transport has received a text message from the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.on(<span class="hljs-string">"text"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>By default, text message is JSON text representing an event object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onevent(<span class="hljs-built_in">JSON</span>.parse(text));
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>When the transport has received a binary message from the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.on(<span class="hljs-string">"binary"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">binary</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>By default, binary message is <a href="http://msgpack.org">MessagePack</a> buffer representing
an event object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onevent(msgpack.decode(binary));
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>When any error has occurred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
        self.emit(<span class="hljs-string">"error"</span>, error);
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>When the transport has been closed for any reason.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.emit(<span class="hljs-string">"close"</span>);
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Aggregates id, heartbeat and _heartbeat, makes URI from them, sends it as the first
message of transport. A client socket will fire <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.send(url.format({
        query: {
          sid: id,
          heartbeat: options.heartbeat,
          _heartbeat: options._heartbeat
        }
      }));</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>As it is possible to exchange events now, fires <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.emit(<span class="hljs-string">"open"</span>);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The underlying transport might be alive.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.state === <span class="hljs-string">"opened"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>If so, closes the transport to make sure there is no connection leak and make the
handshake to be performed on <code>close</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.on(<span class="hljs-string">"close"</span>, handshake);
      transport.close();
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If not, performs the handshake immediately.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      handshake();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>A timer to close the socket after the <code>heartbeat</code> interval.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> heartbeatTimer;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHeartbeatTimer</span>(<span class="hljs-params"></span>) </span>{
    heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"heartbeat"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>It must close transport not socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.close();
    }, options.heartbeat);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>A timer to transition to <code>deleted</code> state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> deleteTimer;
  self.on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Transition to <code>opened</code> state. It transitions to <code>closed</code> state if a connection is closed
for some reason.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"opened"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Sets a heartbeat timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setHeartbeatTimer();</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Resets the delete timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearTimeout(deleteTimer);
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The client will start to heartbeat on its <code>open</code> event and send the heartbaet event
periodically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">"heartbeat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Then, cancels the timer, sets it up again and sends the heartbeat event as a response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearTimeout(heartbeatTimer);
    setHeartbeatTimer();
    self.send(<span class="hljs-string">"heartbeat"</span>);
  });
  self.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Transition to <code>closed</code> state. It transitions to <code>opened</code> state if a connection is
established again again within 1 min or <code>deleted</code> state if not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"closed"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Resets the heartbeat timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearTimeout(heartbeatTimer);
    deleteTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Fires a <code>delete</code> event as this socket ends.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.emit(<span class="hljs-string">"delete"</span>);
    }, <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
  });
  self.on(<span class="hljs-string">"delete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Transition to <code>deleted</code> state. It’s the end of the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"deleted"</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>An id for event. It should be unique among events to be sent to the client and has nothing
to do with one the client sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> eventId = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>A map for reply callbacks for reply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> callbacks = {};
  self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, data, resolved, rejected</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>If it’s not able to send event, fires <code>cache</code> event with arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.state !== <span class="hljs-string">"opened"</span>) {
      self.emit(<span class="hljs-string">"cache"</span>, [type, data, resolved, rejected]);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Event should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: true if this event requires the reply.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> event = {
        id: <span class="hljs-string">""</span> + eventId++,
        type: type,
        data: data,
        reply: resolved != <span class="hljs-literal">null</span> || rejected != <span class="hljs-literal">null</span>
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Stores resolved and rejected callbacks if they are given.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (event.reply) {
        callbacks[event.id] = {resolved: resolved, rejected: rejected};
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Traverses the given data to check if it contains binary. Even if one of properties of
the given data is binary, it can’t be serialized by JSON.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> hasBinary = traverse(data).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hasBuffer, e</span>) </span>{
        <span class="hljs-keyword">return</span> hasBuffer || Buffer.isBuffer(e) || <span class="hljs-built_in">ArrayBuffer</span>.isView(e);
      }, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If the given data contains binary, serializes an event object to
<a href="http://msgpack.org">MessagePack</a>. Otherwise, use JSON.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> message = hasBinary ? msgpack.encode(event) : <span class="hljs-built_in">JSON</span>.stringify(event);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Sends the message through the transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.send(message);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Delegate closing to the transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>If there is active connection,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.state === <span class="hljs-string">"opened"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Closes it which will fire socket’s <code>close</code> event finally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.close();
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If not, it doesn’t need to wait for the delete timer to expire. Regards the socket as
<code>deleted</code> immediately.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      clearTimeout(deleteTimer);
      self.emit(<span class="hljs-string">"delete"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>On the <code>reply</code> event, executes the stored reply callbacks with data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">"reply"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reply</span>) </span>{
    <span class="hljs-keyword">if</span> (reply.id <span class="hljs-keyword">in</span> callbacks) {
      <span class="hljs-keyword">var</span> cbs = callbacks[reply.id];
      <span class="hljs-keyword">var</span> fn = reply.exception ? cbs.rejected : cbs.resolved;
      <span class="hljs-keyword">if</span> (fn) {
        fn.call(<span class="hljs-keyword">this</span>, reply.data);
      }
      <span class="hljs-keyword">delete</span> callbacks[reply.id];
    }
  });
  <span class="hljs-keyword">return</span> self;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
