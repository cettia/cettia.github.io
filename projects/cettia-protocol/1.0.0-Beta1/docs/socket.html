<!DOCTYPE html>

<html>
<head>
  <title>socket.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="socket.html">
                  socket.js
                </a>
              
                
                <a class="source" href="transport-base-transport.html">
                  transport-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-base-transport.html">
                  transport-http-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-longpoll-transport.html">
                  transport-http-longpoll-transport.js
                </a>
              
                
                <a class="source" href="transport-http-server.html">
                  transport-http-server.js
                </a>
              
                
                <a class="source" href="transport-http-stream-transport.html">
                  transport-http-stream-transport.js
                </a>
              
                
                <a class="source" href="transport-websocket-server.html">
                  transport-websocket-server.js
                </a>
              
                
                <a class="source" href="transport-websocket-transport.html">
                  transport-websocket-transport.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>socket.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
 * Cettia
 * http://cettia.io/projects/cettia-protocol/
 * 
 * Copyright 2015 the original author or authors.
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 */</span>
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">"events"</span>);
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">var</span> msgpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">"msgpack-lite"</span>);
<span class="hljs-keyword">var</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">"traverse"</span>);
<span class="hljs-keyword">var</span> createWebSocketTransport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./transport-websocket-transport"</span>);
<span class="hljs-keyword">var</span> createHttpStreamTransport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./transport-http-stream-transport"</span>);
<span class="hljs-keyword">var</span> createHttpLongpollTransport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./transport-http-longpoll-transport"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This function is exposed to the moduleâ€™s <code>open</code> as a factory to create a socket which
establishes a connection to server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">uri, options</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A socket object representing the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>As the state of the socket, it can be one of the following values: <code>connecting</code>, <code>opened</code>,
<code>closed</code> and <code>waiting</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.state = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Prepares for <code>options</code> object to configure socket as well as transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options = options || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A set of factories to create a transport. Given URI, each factory should return a new
transport object if the factory can handle that URI and nothing if not. By modifying this
option, user can write and use their own transports and replace default transports with them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options.transports = options.transports ||
    [createWebSocketTransport, createHttpStreamTransport, createHttpLongpollTransport];</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>A function to determine whether or not to reconnect. It is called every time after the
<code>close</code> event with the last delay in milliseconds used or null at first and the total
number of reconnection attempts. It should return a reconnection delay in milliseconds. A
boolean value of <code>false</code> or a function returning <code>false</code> stand for no reconnection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  options.reconnect = options.reconnect || <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>An identifier of the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> id;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A transport associated with the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> transport;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>A set of variables related to reconnection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> reconnectTimer;
  <span class="hljs-keyword">var</span> reconnectDelay;
  <span class="hljs-keyword">var</span> reconnectTry = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Opens a socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.open = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Resets the previous transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transport = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Because a user might execute this method by force for some reason, it shouldnâ€™t conflict
with the already scheduled reconnection. It cancels the reconnection timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearTimeout(reconnectTimer);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Fires the <code>connecting</code> event that is the first socket event that user can handle after a
little while to give a user a chance to add other event handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      self.emit(<span class="hljs-string">"connecting"</span>);
    }, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Closes the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Prevents further reconnection by setting <code>reconnect</code> option to <code>false</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.reconnect = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Cancels the scheduled reconnection as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clearTimeout(reconnectTimer);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>If itâ€™s connecting to the server,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.state === <span class="hljs-string">"connecting"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>The <code>stop</code> function declared in the below <code>connecting</code> event handler should run. As it
is registered as <code>close</code> event handler, firing <code>close</code> event will execute <code>stop</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.emit(<span class="hljs-string">"close"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>If there is active connection,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (self.state === <span class="hljs-string">"opened"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Closes it which will fire socketâ€™s <code>close</code> event finally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.close();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Finds a working transport and establishes a connection on <code>connecting</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">"connecting"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Transition to <code>connecting</code> state. It transitions to <code>opened</code> state if a connection is
established successfully or <code>closed</code> state if a connection couldnâ€™t be established.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"connecting"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If <code>uri</code> is a string, makes it array. FYI, <code>[].slice.call(uri)</code> returns a copied array of
<code>uri</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> uris = <span class="hljs-built_in">Array</span>.isArray(uri) ? [].slice.call(uri) : [uri];</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Translates abbreviated URIs into normal URIs and attaches <code>id</code> if it exits. Then, the
manipulated <code>uris</code>â€˜s each element corresponds to each transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; uris.length; i++) {
      <span class="hljs-keyword">var</span> urlObj = url.parse(uris[i], <span class="hljs-literal">true</span>);
      <span class="hljs-keyword">delete</span> urlObj.search;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If the socket id exists, attaches it to query under the name of <code>sid</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (id) {
        urlObj.query.sid = id;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>URI whose scheme is <code>http</code> or <code>https</code> and <code>transport</code> param doesnâ€™t exist is an
abbreviated one. It should be translated into three URIs corresponding to WebSocket,
HTTP streaming and HTTP long polling respectively. For example, if uri is
<code>http://localhost:8080/cettia</code>, itâ€™s replaced with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> ((urlObj.protocol === <span class="hljs-string">"http:"</span> || urlObj.protocol === <span class="hljs-string">"https:"</span>) &amp;&amp; !urlObj.query.transport) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>ws://localhost:8080/cettia</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        urlObj.protocol = urlObj.protocol.replace(<span class="hljs-regexp">/^http/</span>, <span class="hljs-string">"ws"</span>);
        <span class="hljs-keyword">var</span> uri1 = url.format(urlObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>http://localhost:8080/cettia?transport=stream</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        urlObj.query.transport = <span class="hljs-string">"stream"</span>;
        <span class="hljs-keyword">var</span> uri2 = url.format(urlObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>and <code>http://localhost:8080/cettia?transport=longpoll</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        urlObj.query.transport = <span class="hljs-string">"longpoll"</span>;
        <span class="hljs-keyword">var</span> uri3 = url.format(urlObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>It means that replace <code>i+1</code>th element with <code>uri1</code>, <code>uri2</code> and <code>uri3</code>. For example,
<code>[1,2,3].splice(1,1,4,5,6)</code> results in <code>[1,4,5,6,3]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        uris.splice(i, <span class="hljs-number">1</span>, uri1, uri2, uri3);
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>FYI, it equals to <code>uris.splice(i, 1, url.format(urlObj))</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        uris[i] = url.format(urlObj);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Starts a process to find a working transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>If there is no remaining URI, fires <code>error</code> and <code>close</code> event as it means that all
tries failed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (uris.length === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Now that <code>connecting</code> event is being fired, if <code>error</code> and <code>close</code> event is fired,
userâ€™s <code>error</code> and <code>close</code> event handlers are always prior to userâ€™s <code>connecting</code> event
handler. As it is nonsense, delay to fire them a little while.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>());
          self.emit(<span class="hljs-string">"close"</span>);
        }, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>A temporal variable to be used while finding working one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> testTransport;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Get the first uri by removing it from <code>uris</code>. For example, <code>[1,2].shift()</code> returns <code>1</code>
and make the array <code>[2]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> uri = uris.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Because transport handles only the specific URI, URI determines transport. It finds
which transport factory can handle this <code>uri</code> among transport factories specified by
<code>transports</code> option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; options.transports.length; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>A transport factory creates and returns transport object if it can handle the given
URI and nothing if not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        testTransport = options.transports[i](uri, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If the factory handles this type of URI,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (testTransport) {
          <span class="hljs-keyword">break</span>;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>If there is no transport matching with the given URI, try a connection with the next URI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!testTransport) {
        find();
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>This is to stop the whole process to find a working transport when the <code>close</code> method
is called before <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stop</span>(<span class="hljs-params"></span>) </span>{
        testTransport.removeListener(<span class="hljs-string">"close"</span>, find);
        testTransport.close();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Until the socket is opened, <code>close</code> method should trigger <code>stop</code> function as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      self.once(<span class="hljs-string">"close"</span>, stop);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>it establishes a connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      testTransport.open();</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>If it fails, it should remove stop listener and try a connection with the next URI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      testTransport.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.removeListener(<span class="hljs-string">"close"</span>, stop);
      });
      testTransport.on(<span class="hljs-string">"close"</span>, find);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Node.js kills the process by default when an <code>error</code> event is fired if there is no
listener for it. However, a user doesnâ€™t need to be notified of an error from this
transport until it is recognized as a working transport as it is a part of a process to
find a working transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      testTransport.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      });</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If it succeeds, a process to find working transport is terminated. The first transport
text message is used to handshake the socket protocol. Note that <code>once</code> registers
one-time event handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      testTransport.once(<span class="hljs-string">"text"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>The handshake output is in the form of URI and uses query part to represent protocol
header.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> headers = url.parse(text, <span class="hljs-literal">true</span>).query;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>The server prints an id of the socket as a protocol header under the name of <code>sid</code>
every time transport connects. If the server issues a new id,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (id !== headers.sid) {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>That means there was no <code>id</code> or the server socket whose id is <code>id</code> was deleted in
the server due to long-term disconnection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          id = headers.sid;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Fires a <code>new</code> event as a new socket is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self.emit(<span class="hljs-string">"new"</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>To maintain an alive connection, <code>heartbeat</code> is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options.heartbeat = +headers.heartbeat;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><code>_heartbeat</code> is usually for testing so it may be not passed from the server. The
default value is <code>5000</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options._heartbeat = +headers._heartbeat || <span class="hljs-number">5000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Now that the working transport is found and handshaking is completed, it removes
<code>close</code> event handler <code>find</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        testTransport.removeListener(<span class="hljs-string">"close"</span>, find);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Associates the working transport with the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport = testTransport;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>When an event object is created from <code>text</code> or <code>binary</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onevent</span>(<span class="hljs-params">event</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Event should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: <code>true</code> if this event requires the reply.
If the server sends a plain event, dispatch it.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (!event.reply) {
            self.emit(event.type, event.data);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> latch;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>A function to create a function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reply</span>(<span class="hljs-params">success</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>A controller function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>The latch prevents double reply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!latch) {
                  latch = <span class="hljs-literal">true</span>;
                  self.send(<span class="hljs-string">"reply"</span>, {id: event.id, data: value, exception: !success});
                }
              };
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Here, the controller is passed to the handler as 2nd argument and calls the
serverâ€™s <code>resolved</code> or <code>rejected</code> callback by sending <code>reply</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self.emit(event.type, event.data, {resolve: reply(<span class="hljs-literal">true</span>), reject: reply(<span class="hljs-literal">false</span>)});
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>When the transport has received a text message from the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.on(<span class="hljs-string">"text"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">text</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>By default, text message is JSON text representing an event object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          onevent(<span class="hljs-built_in">JSON</span>.parse(text));
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>When the transport has received a binary message from the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.on(<span class="hljs-string">"binary"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">binary</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>By default, binary message is <a href="http://msgpack.org">MessagePack</a> buffer representing
an event object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          onevent(msgpack.decode(binary));
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>When any error has occurred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
          self.emit(<span class="hljs-string">"error"</span>, error);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>When the transport has been closed for any reason.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          self.emit(<span class="hljs-string">"close"</span>);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Removes <code>close</code> event handler <code>stop</code> and fires <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.removeListener(<span class="hljs-string">"close"</span>, stop);
        self.emit(<span class="hljs-string">"open"</span>);
      });
    }

    find();
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Starts heartbeat on <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Transition to <code>opened</code> state. It transitions to <code>closed</code> state if a connection is closed
for some reason.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"opened"</span>;
    <span class="hljs-keyword">var</span> heartbeatTimer;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHeartbeatTimer</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Sets a timer to send an <code>heartbeat</code> event after <code>heartbeat - _heartbeat</code> milliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.send(<span class="hljs-string">"heartbeat"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>If the server echoes back the sent <code>heartbeat</code> event, clears the timer and set it again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.once(<span class="hljs-string">"heartbeat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          clearTimeout(heartbeatTimer);
          setHeartbeatTimer();
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Sets a timer to fire a heartbeat error and close the connection if the server doesnâ€™t
respond in the <code>_heartbeat</code> milliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
          self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"heartbeat"</span>));
          transport.close();
        }, options._heartbeat);
      }, options.heartbeat - options._heartbeat);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>The timer should be canceled on <code>close</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.once(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      clearTimeout(heartbeatTimer);
    });
    setHeartbeatTimer();</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Resets a set of variables related to reconnection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    reconnectTimer = reconnectDelay = <span class="hljs-literal">null</span>;
    reconnectTry = <span class="hljs-number">0</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Schedules reconnection on <code>close</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Transition to <code>closed</code> state. It transitions to <code>waiting</code> state if reconnection is scheduled.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"closed"</span>;
    <span class="hljs-keyword">if</span> (options.reconnect) {</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Gives a user a chance to handle <code>close</code> event before firing <code>waiting</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Determines whether to schedule reconnection by providing the last reconnection delay
and the total number of reconnection attempts to <code>reconnect</code> option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        reconnectDelay = options.reconnect.call(self, reconnectDelay, reconnectTry);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>If the returned value is not <code>false</code>, schedules a reconnection timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (reconnectDelay !== <span class="hljs-literal">false</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Increments the number of reconnection attempts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          reconnectTry++;
          reconnectTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            self.open();
          }, reconnectDelay);</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Fires <code>waiting</code> event with information about scheduled reconnection - a time to
wait for reconnection and the number of attempts.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self.emit(<span class="hljs-string">"waiting"</span>, reconnectDelay, reconnectTry);
        }
      }, <span class="hljs-number">0</span>);
    }
  });
  self.on(<span class="hljs-string">"waiting"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">delay, attempts</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Transition to <code>waiting</code> state. It transitions to <code>connecting</code> state after <code>delay</code>
milliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.state = <span class="hljs-string">"waiting"</span>;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>An event id. It should be unique among events to be sent to the server and has nothing to
do with one the server sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> eventId = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>A map for reply callbacks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> callbacks = {};
  self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">type, data, resolved, rejected</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>If itâ€™s not able to send event, fires <code>cache</code> event with arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (self.state !== <span class="hljs-string">"opened"</span>) {
      self.emit(<span class="hljs-string">"cache"</span>, [type, data, resolved, rejected]);
    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>It should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: <code>true</code> if this event requires the reply.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> event = {
        id: <span class="hljs-string">""</span> + eventId++,
        type: type,
        data: data,
        reply: resolved != <span class="hljs-literal">null</span> || rejected != <span class="hljs-literal">null</span>
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Stores resolved and rejected callbacks if they are given.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (event.reply) {
        callbacks[event.id] = {resolved: resolved, rejected: rejected};
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Traverses the given data to check if it contains binary. Even if one of properties of
the given data is binary, it canâ€™t be serialized by JSON.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> hasBinary = traverse(data).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">hasBuffer, e</span>) </span>{
        <span class="hljs-keyword">return</span> hasBuffer || Buffer.isBuffer(e) || <span class="hljs-built_in">ArrayBuffer</span>.isView(e);
      }, <span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>If the given data contains binary, serializes an event object to
<a href="http://msgpack.org">MessagePack</a>. Otherwise, use JSON.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> message = hasBinary ? msgpack.encode(event) : <span class="hljs-built_in">JSON</span>.stringify(event);</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Sends the message through the transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      transport.send(message);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>On the <code>reply</code> event, executes the stored reply callbacks with data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  self.on(<span class="hljs-string">"reply"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reply</span>) </span>{
    <span class="hljs-keyword">if</span> (reply.id <span class="hljs-keyword">in</span> callbacks) {
      <span class="hljs-keyword">var</span> cbs = callbacks[reply.id];
      <span class="hljs-keyword">var</span> fn = reply.exception ? cbs.rejected : cbs.resolved;
      <span class="hljs-keyword">if</span> (fn) {
        fn.call(<span class="hljs-keyword">this</span>, reply.data);
      }
      <span class="hljs-keyword">delete</span> callbacks[reply.id];
    }
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Opens a socket to the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> self.open();
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
