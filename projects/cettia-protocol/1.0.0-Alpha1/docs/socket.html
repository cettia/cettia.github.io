<!DOCTYPE html>

<html>
<head>
  <title>socket.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="socket.html">
                  socket.js
                </a>
              
                
                <a class="source" href="transport-base-transport.html">
                  transport-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-base-transport.html">
                  transport-http-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-longpoll-transport.html">
                  transport-http-longpoll-transport.js
                </a>
              
                
                <a class="source" href="transport-http-server.html">
                  transport-http-server.js
                </a>
              
                
                <a class="source" href="transport-http-stream-transport.html">
                  transport-http-stream-transport.js
                </a>
              
                
                <a class="source" href="transport-websocket-server.html">
                  transport-websocket-server.js
                </a>
              
                
                <a class="source" href="transport-websocket-transport.html">
                  transport-websocket-transport.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>socket.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
 * Cettia
 * http://cettia.io/projects/cettia-protocol/
 * 
 * Copyright 2015 The Cettia Project
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 */</span>
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">"events"</span>);
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">var</span> createWebSocketTransport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./transport-websocket-transport"</span>);
<span class="hljs-keyword">var</span> createHttpStreamTransport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./transport-http-stream-transport"</span>);
<span class="hljs-keyword">var</span> createHttpLongpollTransport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./transport-http-longpoll-transport"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This function is exposed to the module’s <code>open</code> as a factory to create a
socket which establishes a connection to server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(uri, options)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A socket object representing the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Prepares for <code>options</code> object to configure socket. It is passed to
transport factory so it can contain transport options as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options = options || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>A set of factories to create a transport. Given URI, each factory should
return a new transport object if the factory can handle that URI and
nothing if not. By modifying this option, user can write and use their
own transports and replace default transports with them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.transports = options.transports || [createWebSocketTransport, createHttpStreamTransport, createHttpLongpollTransport];</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A reference of transport associated with this socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> transport;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Opens a connection by finding working transport and associating it with
the socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.open = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If <code>uri</code> is a string, makes it array. FYI, <code>[].slice.call(uri)</code>
returns a copied <code>uri</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> uris = <span class="hljs-built_in">Array</span>.isArray(uri) ? [].slice.call(uri) : [uri];</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Translates abbreviated URIs into normal URIs. Then, the manipulated
<code>uris</code>‘s each element corresponds to each transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; uris.length; i++) {
            <span class="hljs-keyword">var</span> urlObj = url.parse(uris[i], <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">delete</span> urlObj.search;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>URI whose scheme is <code>http</code> or <code>https</code> and <code>transport</code> param
doesn’t exist is an abbreviated one. It should be translated into
three URIs corresponding to WebSocket, HTTP streaming and HTTP
long polling respectively. For example, if uri is
<code>http://localhost:8080/cettia</code>, it’s replaced with</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ((urlObj.protocol === <span class="hljs-string">"http:"</span> || urlObj.protocol === <span class="hljs-string">"https:"</span>) &amp;&amp; !urlObj.query.transport) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>ws://localhost:8080/cettia</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                urlObj.protocol = urlObj.protocol.replace(<span class="hljs-regexp">/^http/</span>, <span class="hljs-string">"ws"</span>);
                <span class="hljs-keyword">var</span> uri1 = url.format(urlObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>http://localhost:8080/cettia?transport=stream</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                urlObj.query.transport = <span class="hljs-string">"stream"</span>;
                <span class="hljs-keyword">var</span> uri2 = url.format(urlObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>and <code>http://localhost:8080/cettia?transport=longpoll</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                urlObj.query.transport = <span class="hljs-string">"longpoll"</span>;
                <span class="hljs-keyword">var</span> uri3 = url.format(urlObj);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>It means that replace <code>i+1</code>th element with <code>uri1</code>, <code>uri2</code> and
<code>uri3</code>. For example, <code>[1,2,3].splice(1,1,4,5,6)</code> results in
<code>[1,4,5,6,3]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                uris.splice(i, <span class="hljs-number">1</span>, uri1, uri2, uri3);
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>A temporary transport to be used while finding working transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> trans;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Tries connection with next URI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">open</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>If there is no remaining URI, fires <code>error</code> and <code>close</code> event as
it means that all connection failed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (uris.length === <span class="hljs-number">0</span>) {
                self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>());
                self.emit(<span class="hljs-string">"close"</span>);
                <span class="hljs-keyword">return</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Removes the first element and returns it. For example,
<code>[1,2].shift()</code> returns <code>1</code> and make the array <code>[2]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> uri = uris.shift();</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Because transport can handle only the specific URI, URI
determines transport. It finds which transport can handle this
<code>uri</code> among transports specified by <code>transports</code> option.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; options.transports.length; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Each transport factory checks if the given URI can be handled
and creates and returns transport object if so and returns
nothing if not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                trans = options.transports[i](uri, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If factory creates a transport,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (trans) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>it establishes a connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    trans.open();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>If it fails, it tries with next URI or other transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    trans.on(<span class="hljs-string">"close"</span>, open);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If it succeeds, a process to find working transport is
terminated. At the socket level, the first message is
used to handshake the protocol. <code>once</code> registers one-time
event handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    trans.once(<span class="hljs-string">"text"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(text)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>The handshake output is in the form of URI and uses
query part to get/set header.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">var</span> result = url.parse(text, <span class="hljs-literal">true</span>).query;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>To maintain alive connection, heartbeat is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        options.heartbeat = +result.heartbeat;</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><code>_heartbeat</code> is usually for testing so it may be not
passed from the server. The default value is <code>5000</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        options._heartbeat = +result._heartbeat || <span class="hljs-number">5000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Now that the working transport is found and
handshaking is completed, removes <code>close</code>
event’s <code>open</code> handler which is used to find working
transport,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        trans.removeListener(<span class="hljs-string">"close"</span>, open);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>initializes the transport</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        init(trans);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>and fires <code>open</code> event which is the first event user
can handle socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        self.emit(<span class="hljs-string">"open"</span>);
                    });
                    <span class="hljs-keyword">break</span>;
                }
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>This is to stop the whole process to find a working transport when
the <code>close</code> method is before <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span> </span>{
            trans.removeListener(<span class="hljs-string">"close"</span>, open);
            trans.close();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Until socket is opened, <code>close</code> method should trigger <code>stop</code>
function as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.on(<span class="hljs-string">"close"</span>, stop).on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>If working transport is found, <code>stop</code> should be removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self.removeListener(<span class="hljs-string">"close"</span>, stop);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Now that working transport is determined, associates it with the
socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">(trans)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Assign <code>trans</code> to <code>transport</code> which is associated with the
socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            transport = trans;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>When the transport has received a message from the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            transport.on(<span class="hljs-string">"text"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(text)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Converts JSON text to an event object.</p>
<p>It should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: true if this event requires the reply.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> event = <span class="hljs-built_in">JSON</span>.parse(text);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>If the server sends a plain event, dispatch it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!event.reply) {
                    self.emit(event.type, event.data);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> latch;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>A function to create a function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reply</span><span class="hljs-params">(success)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>A controller function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>The latch prevents double reply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (!latch) {
                                latch = <span class="hljs-literal">true</span>;
                                self.send(<span class="hljs-string">"reply"</span>, {id: event.id, data: value, exception: !success});
                            }
                        };
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Here, the controller is passed to the handler as 2nd
argument and calls the server’s <code>resolved</code> or <code>rejected</code>
callback by sending <code>reply</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    self.emit(event.type, event.data, {resolve: reply(<span class="hljs-literal">true</span>), reject: reply(<span class="hljs-literal">false</span>)});
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>When any error has occurred.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            transport.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error)</span> </span>{
                self.emit(<span class="hljs-string">"error"</span>, error);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>When the transport has been closed for any reason.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            transport.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                self.emit(<span class="hljs-string">"close"</span>);
            });
        }
        open();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Delegate closing to the transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (transport) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>transport’s close finally fires socket’s close event too.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            transport.close();
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>If this method is called while connecting to the server, <code>close</code>
event will execute the above <code>stop</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self.emit(<span class="hljs-string">"close"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>An id for event. It should be unique among events to be sent to the
server and has nothing to do with one the server sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> eventId = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>A map for reply callbacks for reply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> callbacks = {};
    self.send = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, data, resolved, rejected)</span> </span>{
        <span class="hljs-keyword">if</span> (!transport) {
            self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"notopened"</span>));
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>It should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: true if this event requires the reply.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> event = {
            id: <span class="hljs-string">""</span> + eventId++, 
            type: type, 
            data: data, 
            reply: resolved != <span class="hljs-literal">null</span> || rejected != <span class="hljs-literal">null</span>
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Stores resolved and rejected callbacks if they are given.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (event.reply) {
            callbacks[event.id] = {resolved: resolved, rejected: rejected};
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Convert the event to a JSON message and sends it through the
transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.send(<span class="hljs-built_in">JSON</span>.stringify(event));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>On the <code>reply</code> event, executes the stored reply callbacks with data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.on(<span class="hljs-string">"reply"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(reply)</span> </span>{
        <span class="hljs-keyword">if</span> (reply.id <span class="hljs-keyword">in</span> callbacks) {
            <span class="hljs-keyword">var</span> cbs = callbacks[reply.id];
            <span class="hljs-keyword">var</span> fn = reply.exception ? cbs.rejected : cbs.resolved;
            <span class="hljs-keyword">if</span> (fn) {
                fn.call(<span class="hljs-keyword">this</span>, reply.data);
            }
            <span class="hljs-keyword">delete</span> callbacks[reply.id];
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Starts heartbeat on <code>open</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> heartbeatTimer;
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHeartbeatTimer</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Sets a timer to send an <code>heartbeat</code> event after <code>heartbeat -
_heartbeat</code> miliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                self.send(<span class="hljs-string">"heartbeat"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Sets a timer to fire heartbeat error and close the socket if
the server doesn’t respond in the <code>_heartbeat</code> interval.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
                    self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"heartbeat"</span>));
                    self.close();
                }, options._heartbeat);
            }, options.heartbeat - options._heartbeat);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>If the server echoes back the sent <code>heartbeat</code> event, clears the
timer and set it again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.on(<span class="hljs-string">"heartbeat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            clearTimeout(heartbeatTimer);
            setHeartbeatTimer();
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>The timer should be canceled on <code>close</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        self.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            clearTimeout(heartbeatTimer);
        });
        setHeartbeatTimer();
    });
    <span class="hljs-keyword">return</span> self.open();
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
