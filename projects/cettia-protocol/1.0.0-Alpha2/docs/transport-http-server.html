<!DOCTYPE html>

<html>
<head>
  <title>transport-http-server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="server.html">
                  server.js
                </a>
              
                
                <a class="source" href="socket.html">
                  socket.js
                </a>
              
                
                <a class="source" href="transport-base-transport.html">
                  transport-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-base-transport.html">
                  transport-http-base-transport.js
                </a>
              
                
                <a class="source" href="transport-http-longpoll-transport.html">
                  transport-http-longpoll-transport.js
                </a>
              
                
                <a class="source" href="transport-http-server.html">
                  transport-http-server.js
                </a>
              
                
                <a class="source" href="transport-http-stream-transport.html">
                  transport-http-stream-transport.js
                </a>
              
                
                <a class="source" href="transport-websocket-server.html">
                  transport-websocket-server.js
                </a>
              
                
                <a class="source" href="transport-websocket-transport.html">
                  transport-websocket-transport.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>transport-http-server.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*
 * Cettia
 * http://cettia.io/projects/cettia-protocol/
 * 
 * Copyright 2015 The Cettia Project
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 */</span>
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">"events"</span>);
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-uuid"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This function is exposed to the module’s <code>transport</code> module’s
<code>createHttpServer</code> as a factory to create server which consumes HTTP
request-response exchange and produces transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A transport server object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Since a HTTP transport consists of multiple HTTP exchanges, transport
object is needed to be retrieved using identifier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> transports = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>When HTTP transport is opened,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.on(<span class="hljs-string">"transport"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">transport</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Adds it to the set by id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transports[transport.id] = transport;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>And removes it from the set by id if it’s closed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">delete</span> transports[transport.id];
        });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>A link between Cettia HTTP transport protocol and Node.js. <code>req</code> and
<code>res</code> are expected to be passed from Node.js’s <code>http/https</code> module’
server’ <code>request</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.handle = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
        req.params = url.parse(req.url, <span class="hljs-literal">true</span>).query;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Any request must not be cached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.setHeader(<span class="hljs-string">"cache-control"</span>, <span class="hljs-string">"no-cache, no-store, must-revalidate"</span>);
        res.setHeader(<span class="hljs-string">"pragma"</span>, <span class="hljs-string">"no-cache"</span>);
        res.setHeader(<span class="hljs-string">"expires"</span>, <span class="hljs-string">"0"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Transports using <code>XDomainRequest</code> require CORS headers even in
same-origin connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.setHeader(<span class="hljs-string">"access-control-allow-origin"</span>, req.headers.origin || <span class="hljs-string">"*"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>As <code>content-type</code> header, <code>text/plain</code> for text message and
<code>application/octet-stream</code> for binary message are used. But, because
the latter is not said to be a “simple headers” defined by CORS spec,
<code>content-type</code> header should be listed as a value of
<code>access-control-allow-headers</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.setHeader(<span class="hljs-string">"access-control-allow-headers"</span>, <span class="hljs-string">"content-type"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>For convenience.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.setHeader(<span class="hljs-string">"access-control-allow-credentials"</span>, <span class="hljs-string">"true"</span>);
        <span class="hljs-keyword">switch</span> (req.method) {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>OPTIONS</code> method is used to handle CORS preflight request. Since the
client needs to get <code>content-type</code> response header and it may be
<code>application/octet-stream</code> which is not “simple header” coined by
CORS spec, browser will perform this preflight request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">case</span> <span class="hljs-string">"OPTIONS"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Ends the response as necessary headers are already set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res.end();
            <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><code>GET</code> method is used to establish a channel for the server to write
message to the client and manage existing transports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">case</span> <span class="hljs-string">"GET"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p><code>when</code> param indicates a specific goal of <code>GET</code> request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">switch</span> (req.params.when) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>To establish a new channel.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">case</span> <span class="hljs-string">"open"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><code>transport</code> param is transport name the client uses which
is either <code>stream</code> or <code>longpoll</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">switch</span> (req.params.transport) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"stream"</span>:
                    self.emit(<span class="hljs-string">"transport"</span>, createStreamTransport(req, res));
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"longpoll"</span>:
                    self.emit(<span class="hljs-string">"transport"</span>, createLongpollTransport(req, res));
                    <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>For unknown transport param, responds with <code>501 Not
Implemented</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">default</span>:
                    res.statusCode = <span class="hljs-number">501</span>;
                    res.end();
                    <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>To inject a new HTTP request-response exchange to long polling
transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">case</span> <span class="hljs-string">"poll"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Finds the corresponding transport by <code>id</code> param.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> transport = transports[req.params.id];
                <span class="hljs-keyword">if</span> (transport) {
                    transport.refresh(req, res);
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>If there is no corresponding socket, responds with <code>500
Internal Server Error</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    res.statusCode = <span class="hljs-number">500</span>;
                    res.end();
                }
                <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>To notify server of disconnection by client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">case</span> <span class="hljs-string">"abort"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Finds the corresponding transport by <code>id</code> param.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> transport = transports[req.params.id];</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If server detected disconnection correctly, <code>transport</code>
should have been null.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (transport) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>For some reason, the server couldn’t detect disconnection
then close connection to fire <code>close</code> event to transport
manually.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    transport.close();
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>In case of browser, it is performed by script tag so set
content-type header to <code>text/javascript</code> to avoid warning.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.setHeader(<span class="hljs-string">"content-type"</span>, <span class="hljs-string">"text/javascript; charset=utf-8"</span>);
                res.end();
                <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>For unknown <code>when</code> param, responds with <code>501 Not Implemented</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">default</span>:
                res.statusCode = <span class="hljs-number">501</span>;
                res.end();
            }
            <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><code>POST</code> method is used to establish a channel for the client to write
message to the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">case</span> <span class="hljs-string">"POST"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Reads the request body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> chunks = [];
            req.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>{
                chunks.push(chunk);
            });
            req.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Finds the corresponding transport by <code>id</code> param.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> transport = transports[req.params.id];
                <span class="hljs-keyword">if</span> (transport) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>The complete body in the form of binary.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> body = Buffer.concat(chunks);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Makes content-type header lowercase and verifies it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">switch</span> ((req.headers[<span class="hljs-string">"content-type"</span>] || <span class="hljs-string">""</span>).toLowerCase()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>A list of allowed content-type headers for text message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">"text/plain; charset=utf-8"</span>:
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"text/plain; charset=utf8"</span>:
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"text/plain;charset=utf-8"</span>:
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"text/plain;charset=utf8"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Fires <code>text</code> event by decoding the body with
<code>utf-8</code> and stripping off leading <code>data=</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        transport.emit(<span class="hljs-string">"text"</span>, body.toString(<span class="hljs-string">"utf-8"</span>, <span class="hljs-string">"data="</span>.length));
                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>An allowed content-type header for binary message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">case</span> <span class="hljs-string">"application/octet-stream"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Fires <code>binary</code> event with the body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        transport.emit(<span class="hljs-string">"binary"</span>, body);
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>If the content-type header is invalid, fires an error
and closes the connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        transport.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"protocol"</span>));
                        transport.close();</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>And responds with <code>500 Internal Server Error</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        res.statusCode = <span class="hljs-number">500</span>;
                        <span class="hljs-keyword">break</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>If the specified transport is not found, responds with <code>500
Internal Server Error</code>. It might happen if the transport is
closed while reading request body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="hljs-keyword">else</span> {
                    res.statusCode = <span class="hljs-number">500</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>The response should end after processing the request body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.end();
            });
            <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>If the method is neither <code>GET</code> nor <code>POST</code>, responds with <code>405 Method
Not Allowed</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">default</span>:
            res.statusCode = <span class="hljs-number">405</span>;
            res.end();
        }
    };
    <span class="hljs-keyword">return</span> self;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>A base transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createBaseTransport</span>(<span class="hljs-params">req, res</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>A transport object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Because HTTP transport consists of multiple exchanges, an universally
unique identifier is required.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.id = uuid.v4();</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Transport URI contains information like protocol header as query.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.uri = req.url;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>A flag to check the transport is opened.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> opened = <span class="hljs-literal">true</span>;
    self.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        opened = <span class="hljs-literal">false</span>;
    });
    self.send = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Allows to send data only it is opened. If not, fires an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (opened) {
            self.write(data);
        } <span class="hljs-keyword">else</span> {
            self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"notopened"</span>));
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };
    <span class="hljs-keyword">return</span> self;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>The client performs a HTTP persistent connection and watches changes in
response and the server prints chunk as data to response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStreamTransport</span>(<span class="hljs-params">req, res</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>A transport object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = createBaseTransport(req, res);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Any error on request-response should propagate to transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    req.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
        self.emit(<span class="hljs-string">"error"</span>, error);
    });
    res.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
        self.emit(<span class="hljs-string">"error"</span>, error);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>When the underlying connection was terminated abnormally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.emit(<span class="hljs-string">"close"</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>When the complete response has been sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.on(<span class="hljs-string">"finish"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        self.emit(<span class="hljs-string">"close"</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>The response body should be formatted in the <a href="http://www.w3.org/TR/eventsource/#parsing-an-event-stream">event stream
format</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p><code>data</code> should be either a <code>Buffer</code> or a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>A text message should be prefixed with <code>1</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            data = <span class="hljs-string">"1"</span> + data;
        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>A binary message should be encoded in Base64 and prefixed with
<code>2</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            data = <span class="hljs-string">"2"</span> + data.toString(<span class="hljs-string">"base64"</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>According to the format, data should be broken up by <code>\r</code>, <code>\n</code>, or
<code>\r\n</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> payload = data.split(<span class="hljs-regexp">/\r\n|[\r\n]/</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Each line should be prefixed with ‘data: ‘ and postfixed with
<code>\n</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> <span class="hljs-string">"data: "</span> + line + <span class="hljs-string">"\n"</span>;
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Prints <code>\n</code> as the last character of a message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .join(<span class="hljs-string">""</span>) + <span class="hljs-string">"\n"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Writes it to response with <code>utf-8</code> encoding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.write(payload, <span class="hljs-string">"utf-8"</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Ends the response. Accordingly, <code>res</code>‘s <code>finish</code> event will be fired.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        res.end();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>The content-type headers should be <code>text/event-stream</code> for Server-Sent
Events and <code>text/plain</code> for others. Also the response should be encoded in <code>utf-8</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.setHeader(<span class="hljs-string">"content-type"</span>, <span class="hljs-string">"text/"</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>If it’s Server-Sent Events, <code>sse</code> param is <code>true</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        (req.params.sse === <span class="hljs-string">"true"</span> ? <span class="hljs-string">"event-stream"</span> : <span class="hljs-string">"plain"</span>) + <span class="hljs-string">"; charset=utf-8"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>The padding is required, which makes the client-side transport on old
browsers be aware of change of the response. It should be greater
than 1KB, be composed of white space character and end with <code>\n</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> text2KB = <span class="hljs-built_in">Array</span>(<span class="hljs-number">2048</span>).join(<span class="hljs-string">" "</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Some host objects which are used to perform streaming transport can’t or
don’t allow to read response headers as well as write request headers.
That’s why we uses the first message as a handshake output. The handshake
result should be formatted in URI. And transport id should be added as
<code>id</code> param.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> uri = url.format({query: {id: self.id}});</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Likewise some host objects in old browsers, junk data is needed to make
themselves be aware of change of response. Prints the padding and the
first message following <code>text/event-stream</code> with <code>utf-8</code> encoding.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    res.write(text2KB + <span class="hljs-string">"\ndata: "</span> + uri + <span class="hljs-string">"\n\n"</span>, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> self;    
}</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>The client performs a HTTP persistent connection and the server ends the
response with data. Then, the client receives it and performs a request again
and again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createLongpollTransport</span>(<span class="hljs-params">req, res</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>The current response which can be used to send a message or close the
connection. It’s not null when it’s available and null when it’s not
available.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> response;</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>A flag to mark this transport is aborted. It’s used when <code>response</code> is
not available, if user closes the connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> aborted;</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>A timer to prevent from being idle connection which may happen if the
succeeding poll request is not arrived.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> closeTimer;</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>The parameters of the first request. That of subsequent requests are not
used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> params = req.params;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>A queue containing messages that the server couldn’t send.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> queue = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>A transport object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> self = createBaseTransport(req, res);</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>In long polling, multiple HTTP exchanges are used to establish a channel
for the server to write message to client. This function will be called
every time the client performs a request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.refresh = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Any error on request-response should propagate to transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        req.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
            self.emit(<span class="hljs-string">"error"</span>, error);
        });
        res.on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) </span>{
            self.emit(<span class="hljs-string">"error"</span>, error);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>When the underlying connection was terminated abnormally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            self.emit(<span class="hljs-string">"close"</span>);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>When the complete response has been sent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.on(<span class="hljs-string">"finish"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>If this request was to <code>poll</code> and this response was ended through
<code>end</code> not <code>endedWithMessage</code>, it means it is the end of the
transport. Hence, fires the <code>close</code> event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (req.params.when === <span class="hljs-string">"poll"</span> &amp;&amp; !res.endedWithMessage) {
                self.emit(<span class="hljs-string">"close"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Otherwise the client will issue <code>poll</code> request again. If not,
this connection falls into limbo. To prevent that, it sets a
timer which fires <code>close</code> event unless the client issues <code>poll</code>
request in 3s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="hljs-keyword">else</span> {
                closeTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                    self.emit(<span class="hljs-string">"close"</span>);
                }, <span class="hljs-number">3000</span>);
            }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>A custom property to show how it was ended through either
<code>endWithMessage</code> for sending a message or <code>end</code> for closing the
connection. An ended response can’t be used again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.endedWithMessage = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>A custom method to send a message through this response.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res.endWithMessage = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Flags the current response is ended with message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res.endedWithMessage = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p><code>data</code> should be either a <code>Buffer</code> or a string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">"string"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>As for text message, the content-type header should be
<code>text/javascript</code> for JSONP and <code>text/plain</code> for the others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.setHeader(<span class="hljs-string">"content-type"</span>, <span class="hljs-string">"text/"</span> +</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>If it’s JSONP, <code>jsonp</code> param is <code>true</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    (params.jsonp === <span class="hljs-string">"true"</span> ? <span class="hljs-string">"javascript"</span> : <span class="hljs-string">"plain"</span>) + <span class="hljs-string">"; charset=utf-8"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>All the long polling transports have to finish the request
after processing. The <code>res</code>‘s <code>finish</code> event will be fired
after this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.end(params.jsonp === <span class="hljs-string">"true"</span> ?</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>In case of JSONP, the response text is supposed to be a
JavaScript code executing a callback with data. The
callback name is passed as the first request’s <code>callback</code>
param and the data to be returned have to be escaped to a
JavaScript string literal. For others, no formatting is
needed. In any case, data should be encoded in <code>utf-8</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    params.callback + <span class="hljs-string">"("</span> + <span class="hljs-built_in">JSON</span>.stringify(data) + <span class="hljs-string">");"</span> : data, <span class="hljs-string">"utf-8"</span>);
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>As for binary message, the content-type header should be
<code>application/octet-stream</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                res.setHeader(<span class="hljs-string">"content-type"</span>, <span class="hljs-string">"application/octet-stream"</span>);
                res.end(data);
            }
        };
        <span class="hljs-keyword">switch</span> (req.params.when) {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>The first request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">case</span> <span class="hljs-string">"open"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p><code>script</code> tag which is a host object used in old browsers to
perform long polling transport can’t read response headers as
well as write request headers. That’s why we uses the first
response’s body as a handshake output instead of headers. The
handshake result should be formatted in URI. And transport id
should be added as <code>id</code> param.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res.endWithMessage(url.format({query: {id: self.id}}));
            <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>The succeeding request after the first request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">case</span> <span class="hljs-string">"poll"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Resets timer as new exchange is supplied.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            clearTimeout(closeTimer);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>If aborted is <code>true</code> here, it means the user tried to close the
connection but it couldn’t be done because <code>response</code> was null.
So ends this incoming exchange. It will fire <code>close</code> event
through <code>res</code>‘s <code>finish</code> event handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (aborted) {
                res.end();
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>If the queue is not empty, it means there are remaining
messages so that the server should send them again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (queue.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Removes the first cached message from the queue and send
it. FYI, <code>[1,2,3].shift()</code> returns in <code>1</code> and results in
<code>[2,3]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    res.endWithMessage(queue.shift());
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>If not, assigns <code>res</code> to <code>response</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    response = res;
                }
            }
            <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>If this function complies to the contract, it shouldn’t happen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">default</span>:
            self.emit(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"protocol"</span>));
            self.close();
            <span class="hljs-keyword">break</span>;
        }
    };
    self.write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Only when the current response exists, it’s possible to send a
message.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (response) {</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>After <code>response.endWithMessage</code>, <code>response</code> can’t be used again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> resp = response;
            response = <span class="hljs-literal">null</span>;
            resp.endWithMessage(data);</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>If not, the data will be cached and sent in next poll through
<code>refresh</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
            queue.push(data);
        }
    };
    self.close = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Only when the current response exists, it’s possible to close the
connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (response) {</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>After <code>response.end</code>, <code>response</code> can’t be used again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> resp = response;
            response = <span class="hljs-literal">null</span>;
            resp.end();</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>If not, a next poll request will be ended immediately by <code>aborted</code>
flag through <code>refresh</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        } <span class="hljs-keyword">else</span> {
            aborted = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Refreshes with the first exchange.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    self.refresh(req, res);
    <span class="hljs-keyword">return</span> self;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
