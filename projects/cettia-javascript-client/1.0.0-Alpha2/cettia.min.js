/* Cettia v1.0.0-Alpha2 | http://cettia.io/projects/cettia-javascript-client/ | (c) 2015, The Cettia Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(h,n){if("function"===typeof define&&define.amd)define([],function(){return n(h)});else if("object"===typeof exports){var x=require("jsdom").jsdom().parentWindow;x.WebSocket=require("ws");x.EventSource=require("eventsource");module.exports=n(x);module.exports.util.corsable=!0}else h.cettia=n(h)})(this,function(h){function n(b){var c,a,d,e,f,l,g=[],h=function(h,m){m=m||[];a=!b||[h,m];d=!0;l=e||0;e=0;for(f=g.length;l<f&&!c;l++)g[l].apply(h,m);d=!1};return{add:function(b){var l=g.length;g.push(b);
d?f=g.length:!c&&a&&!0!==a&&(e=l,h(a[0],a[1]))},remove:function(b){var a;for(a=0;a<g.length;a++)if(b===g[a]||b.guid&&b.guid===g[a].guid)d&&a<=f&&(f--,a<=l&&l--),g.splice(a--,1)},fire:function(e,f){c||d||b&&a||h(e,f)},lock:function(){c=!0},locked:function(){return!!c},unlock:function(){c=a=d=e=f=l=void 0}}}function x(b,c){var a={reconnect:function(a){return 2*(a||250)},transports:[E,F,G]};if(c)for(var d in c)a[d]=c[d];c=a;var e={},f={};e.on=function(a,b){var e;e=f[a];if(!e){if(f.message.locked())return this;
e=f[a]=n();e.order=f.message.order}e.add(b);return this};e.off=function(a,b){var e=f[a];e&&e.remove(b);return this};e.once=function(a,b){function c(){e.off(a,c);b.apply(e,arguments)}b.guid=b.guid||w++;c.guid=b.guid;return e.on(a,c)};e.fire=function(a){var b=f[a];b&&b.fire(e,C.call(arguments,1));return this};var l,r,p,u=0;e.open=function(){l=null;clearTimeout(r);f.connecting.unlock();f.open.unlock();return e.fire("connecting")};e.close=function(){c.reconnect=!1;clearTimeout(r);"connecting"===t?e.fire("close"):
"opened"===t&&l.close();return this};var m;c.name&&h.name&&(m=g.parseJSON(h.name)[c.name]);var t;e.state=function(){return t};for(d in{connecting:1,open:1,close:1,waiting:1})f[d]=n(!0),f[d].order=w++;f.message=n(!1);f.message.order=f.open.order;e.on("connecting",function(){t="connecting";for(var a=g.isArray(b)?C.call(b):[b],d=0;d<a.length;d++){var f=a[d]=g.stringifyURI(g.makeAbsolute(a[d]),{sid:m});/^https?:/.test(f)&&!g.parseURI(f).query.transport&&(a.splice(d,1,f.replace(/^http/,"ws"),g.stringifyURI(f,
{transport:"stream"}),g.stringifyURI(f,{transport:"longpoll"})),d+=2)}(function y(){function b(){f.off("close",y).close()}var d=a.shift();if(d){for(var f,k=0;k<c.transports.length&&!(f=c.transports[k](d,c));k++);f?(e.once("close",b),f.on("close",y).on("close",function(){e.off("close",b)}).on("text",function M(a){f.off("text",M);a=g.parseURI(a).query;m!==a.sid&&(m=a.sid,e.fire("new"));c.heartbeat=+a.heartbeat;c._heartbeat=+a._heartbeat||5E3;l=f.off("close",y);var d;l.on("text",function(a){if(d){var b=
g.parseJSON(a),f;a=function(a){return function(d){f||(f=!0,e.send("reply",{id:b.id,data:d,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];e.fire.apply(e,a)}else d=!0}).on("error",function(a){e.fire("error",a)}).on("close",function(){e.fire("close")});e.off("close",b).fire("open")}).open()):y()}else e.fire("error",Error()).fire("close")})()}).on("new",function(){if(c.name){var a=h.name?g.parseJSON(h.name):{};a[c.name]=m;h.name=g.stringifyJSON(a)}}).on("open",function(){t=
"opened";var a;(function L(){a=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(a);L()});a=setTimeout(function(){e.fire("error",Error("heartbeat"));l.close()},c._heartbeat)},c.heartbeat-c._heartbeat)})();e.once("close",function(){clearTimeout(a)});f.connecting.lock();r=p=null;u=0}).on("close",function(){t="closed";f.connecting.lock();f.open.lock();if(c.reconnect)e.once("close",function(){p=c.reconnect.call(e,p,u);!1!==p&&(u++,r=setTimeout(function(){e.open()},p),
e.fire("waiting",p,u))})}).on("waiting",function(){t="waiting"});var k={};e.send=function(a,b,d,f){if("opened"!==t)return e.fire("cache",[a,b,d,f]),this;a={id:w++,type:a,data:b,reply:!(!d&&!f)};a.reply&&(k[a.id]=[d,f]);l.send(g.stringifyJSON(a));return this};e.on("reply",function(a){k[a.id][+a.exception].call(e,a.data);delete k[a.id]});return e.open()}function H(b,c){var a=c&&c.timeout||3E3,d={open:function(){function b(){clearTimeout(f)}d.connect();var f=setTimeout(function(){d.fire("error",Error("timeout")).close()},
a);d.on("open",b).on("close",b);return this}},e={open:n(!0),text:n(),binary:n(),error:n(),close:n(!0)};d.on=function(a,b){e[a].add(b);return this};d.off=function(a,b){e[a].remove(b);return this};d.fire=function(a){e[a].fire(d,C.call(arguments,1));return this};var f=!1;d.on("open",function(){f=!0});d.on("close",function(){f=!1;for(var a in e)"close"!==a&&e[a].lock()});d.send=function(a){f?d.write(a):d.emit("error",Error("notopened"));return this};return d}function E(b,c){var a=h.WebSocket;if(a&&/^wss?:/.test(b)){var d,
e=H(b,c);e.connect=function(){d=new a(b);d.binaryType="arraybuffer";d.onopen=function(){e.fire("open")};d.onmessage=function(a){"string"===typeof a.data?e.fire("text",a.data):e.fire("binary",a.data)};d.onerror=function(){e.fire("error",Error()).fire("close")};d.onclose=function(){e.fire("close")}};e.write=function(a){d.send(a)};e.close=function(){d.close();return this};return e}}function I(b,c){var a=c&&c.xdrURL,d=H(b,c),e;d.on("open",function(){e=g.stringifyURI(b,{id:d.id})}).on("close",function(){e=
null});var f=!1,l=[],r=function(){l.length?u(l.shift()):f=!1},p=function(){e&&d.fire("error",Error()).close()},u=!g.crossOrigin(b)||g.corsable?function(a){var b=g.createXMLHttpRequest();b.onreadystatechange=function(){4===b.readyState&&(200===b.status?r():p())};b.open("POST",e);g.corsable&&(b.withCredentials=!0);"string"===typeof a?(b.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),b.send("data="+a)):(b.setRequestHeader("Content-Type","application/octet-stream"),b.send(a));return this}:
h.XDomainRequest&&a?function(b){var f=new h.XDomainRequest;f.onload=r;f.onerror=p;f.open("POST",a.call(d,e));f.send("data="+b);return this}:function(a){var b=q.createElement("form");b.action=e;b.target="socket-"+w++;b.method="POST";b.enctype=b.encoding="text/plain";b.acceptCharset="UTF-8";b.style.display="none";b.innerHTML='<textarea name="data"></textarea><iframe name="'+b.target+'"></iframe>';b.firstChild.value=a;a=b.lastChild;g.on(a,"error",function(){p()});g.on(a,"load",function(){q.body.removeChild(b);
r()});q.body.appendChild(b);b.submit();return this};d.write=function(a){f?l.push(a):(f=!0,u(a))};var m;d.close=function(){d.abort();if(!m){m=!0;var a=q.createElement("script");a.async=!1;a.src=g.stringifyURI(b,{id:d.id,when:"abort"});a.onload=a.onerror=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),d.fire("close")};z.insertBefore(a,z.firstChild)}return this};return d}function F(b,c){if(/^https?:/.test(b)&&
"stream"===g.parseURI(b).query.transport)return N(b,c)||O(b,c)||P(b,c)||Q(b,c)}function A(b,c){var a="",d=I(b,c);d.parse=function(b){if(b=b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var e=0;e<b.length-1;e++)d.onmessage(b[e].substring(6));a=b[b.length-1]}};var e;d.onmessage=function(a){if(e){var b=a.substring(0,1);a=a.substring(1);switch(b){case "1":d.fire("text",a);break;case "2":if("object"===typeof exports)a=new Buffer(a,"base64");else{b=atob(a);a=new Uint8Array(a.length);for(var c=0;c<b.length;c++)a[c]=
b.charCodeAt(c);a=a.buffer}d.fire("binary",a)}}else e=!0,b=g.parseURI(a).query,d.id=b.id,d.fire("open")};return d}function N(b,c){var a=h.EventSource;if(a&&!(g.crossOrigin(b)&&g.browser.safari&&7>g.browser.vmajor)){var d,e=A(b,c);e.connect=function(){d=new a(b+"&when=open&sse=true",{withCredentials:!0});d.onmessage=function(a){e.onmessage(a.data)};d.onerror=function(){d.close();e.fire("close")}};e.abort=function(){d.close()};return e}}function O(b,c){if(!(g.browser.msie&&10>g.browser.vmajor||g.crossOrigin(b)&&
!g.corsable)){var a,d=A(b,c);d.connect=function(){var e;a=g.createXMLHttpRequest();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d.parse(e?a.responseText.substring(e):a.responseText),e=a.responseText.length):4===a.readyState&&(200!==a.status&&d.fire("error",Error()),d.fire("close"))};a.open("GET",b+"&when=open");g.corsable&&(a.withCredentials=!0);a.send()};d.abort=function(){a.abort()};return d}}function P(b,c){var a=c&&c.xdrURL,d=h.XDomainRequest;if(a&&d){var e,f=A(b,c);f.connect=
function(){var c;e=new d;e.onprogress=function(){f.parse(c?e.responseText.substring(c):e.responseText);c=e.responseText.length};e.onerror=function(){f.fire("error",Error()).fire("close")};e.onload=function(){f.fire("close")};e.open("GET",a.call(f,b+"&when=open"));e.send()};f.abort=function(){e.abort()};return f}}function Q(b,c){var a=h.ActiveXObject;if(a&&!g.crossOrigin(b)){var d,e,f=A(b,c);f.connect=function(){function c(a){var b;(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}
d=new a("htmlfile");d.open();d.close();var g=d.createElement("iframe");g.src=b+"&when=open";d.body.appendChild(g);var h=g.contentDocument||g.contentWindow.document;e=c(function(){function a(){var c=b.cloneNode(!0);c.appendChild(h.createTextNode("."));c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(h.firstChild){var b=h.body.lastChild;if(!b)return f.fire("error",Error()).fire("close"),!1;f.parse(a());b.innerText="";e=c(function(){var c=a();c&&(b.innerText="",f.parse(c));if("complete"===
h.readyState)return f.fire("close"),!1});return!1}})};f.abort=function(){e();d.execCommand("Stop")};return f}}function G(b,c){if(/^https?:/.test(b)&&"longpoll"===g.parseURI(b).query.transport)return R(b,c)||S(b,c)||T(b,c)}function D(b,c){var a=I(b,c);a.connect=function(){a.poll(b+"&when=open",function(c){c=g.parseURI(c).query;a.id=c.id;(function f(){a.poll(g.stringifyURI(b,{id:a.id,when:"poll"}),function(b){b?(f(),"string"===typeof b?a.fire("text",b):a.fire("binary",b)):a.fire("close")})})();a.fire("open")})};
return a}function R(b,c){if(!g.crossOrigin(b)||g.corsable){var a,d=D(b,c);d.poll=function(b,c){a=g.createXMLHttpRequest();a.onreadystatechange=function(){switch(a.readyState){case 2:"application/octet-stream"===a.getResponseHeader("content-type")&&(a.responseType="arraybuffer");break;case 4:200===a.status?c(a.response||a.responseText):d.fire("error",Error()).fire("close")}};a.open("GET",b);g.corsable&&(a.withCredentials=!0);a.send(null)};d.abort=function(){a.abort()};return d}}function S(b,c){var a=
c&&c.xdrURL,d=h.XDomainRequest;if(a&&d){var e,f=D(b,c);f.poll=function(b,c){b=a.call(f,b);e=new d;e.onload=function(){c(e.responseText)};e.onerror=function(){f.fire("error",Error()).fire("close")};e.open("GET",b);e.send()};f.abort=function(){e.abort()};return f}}function T(b,c){var a,d=D(b,c),e=J.pop()||"socket_"+w++;h[e]=function(b){a.responseText=b};d.on("close",function(){h[e]=function(){};J.push(e)});d.poll=function(b,c){a=q.createElement("script");a.async=!0;a.src=g.stringifyURI(b,{jsonp:"true",
callback:e});a.clean=function(){a.clean=a.onerror=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&(a.clean&&a.clean(),c(a.responseText),a.responseText=null)};a.onerror=function(){a.clean();d.fire("error",Error()).fire("close")};z.insertBefore(a,z.firstChild)};d.abort=function(){a.clean&&a.clean()};return d}var w=1,C=Array.prototype.slice,K=Object.prototype.toString,U=Object.prototype.hasOwnProperty,
q=h.document,B=h.location,V=h.navigator,z=q.head||q.getElementsByTagName("head")[0]||q.documentElement,g={};g.isArray=Array.isArray||function(b){return"[object Array]"===K.call(b)};g.makeAbsolute=function(b){var c=q.createElement("div");c.innerHTML='<a href="'+b+'"/>';return encodeURI(decodeURI(c.firstChild.href))};g.on=function(b,c,a){b.addEventListener?b.addEventListener(c,a,!1):b.attachEvent&&b.attachEvent("on"+c,a)};g.stringifyURI=function(b,c){var a,d=[];c=c||{};c._=w++;for(a in c)null!=c[a]&&
d.push(encodeURIComponent(a)+"="+encodeURIComponent(c[a]));return b+(/\?/.test(b)?"&":"?")+d.join("&").replace(/%20/g,"+")};g.parseURI=function(b){var c={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var d=b[a].split("=");c.query[decodeURIComponent(d[0])]=decodeURIComponent(d[1]||"")}}return c};g.createXMLHttpRequest=function(){try{return new h.XMLHttpRequest}catch(b){try{return new h.ActiveXObject("Microsoft.XMLHTTP")}catch(c){}}};g.parseJSON=h.JSON?h.JSON.parse:
function(b){return Function("return "+b)()};g.stringifyJSON=h.JSON?h.JSON.stringify:function(b){function c(a){return'"'+a.replace(d,function(a){var b=e[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function l(b,
e){var d,g,h,k=e[b];h=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(b),h=typeof k);switch(h){case "string":return c(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";switch(K.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":g=
k.length;h=[];for(d=0;d<g;d++)h.push(l(d,k)||"null");return"["+h.join(",")+"]";default:h=[];for(d in k)U.call(k,d)&&(g=l(d,k))&&h.push(c(d)+":"+g);return"{"+h.join(",")+"}"}}}("",{"":b})};g.corsable="withCredentials"in g.createXMLHttpRequest();g.browser=function(){var b=V.userAgent.toLowerCase(),c={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");c[b[1]||""]=!0;c.version=
b[2]||"0";c.vmajor=c.version.split(".")[0];c.trident&&(c.msie=!0);return c}();g.crossOrigin=function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());return!(!b||b[1]==B.protocol&&b[2]==B.hostname&&(b[3]||("http:"===b[1]?80:443))==(B.port||("http:"===B.protocol?80:443)))};var J=[],v=[];g.on(h,"unload",function(){for(var b,c=0;c<v.length;c++)b=v[c],"closed"!==b.state()&&b.close()});g.on(h,"online",function(){for(var b,c=0;c<v.length;c++)b=v[c],"waiting"===b.state()&&b.open()});
g.on(h,"offline",function(){for(var b,c=0;c<v.length;c++)b=v[c],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return{open:function(b,c){var a=x(b,c);v.push(a);return a},transport:{createWebSocketTransport:E,createHttpStreamTransport:F,createHttpLongpollTransport:G},util:g}});