/* Cettia v1.0.0-Alpha1 | http://cettia.io/projects/cettia-javascript-client/ | (c) 2015, The Cettia Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(h,m){if("function"===typeof define&&define.amd)define([],function(){return m(h)});else if("object"===typeof exports){var w=require("jsdom").jsdom().parentWindow;w.WebSocket=require("ws");w.EventSource=require("eventsource");module.exports=m(w);module.exports.util.corsable=!0}else h.cettia=m(h)})(this,function(h){function m(b){var e,a,d,c,f,l,g=[],h=function(p,n){n=n||[];a=!b||[p,n];d=!0;l=c||0;c=0;for(f=g.length;l<f&&!e;l++)g[l].apply(p,n);d=!1};return{add:function(b){var l=g.length;g.push(b);
d?f=g.length:!e&&a&&!0!==a&&(c=l,h(a[0],a[1]))},remove:function(b){var a;for(a=0;a<g.length;a++)if(b===g[a]||b.guid&&b.guid===g[a].guid)d&&a<=f&&(f--,a<=l&&l--),g.splice(a--,1)},fire:function(c,f){e||d||b&&a||h(c,f)},lock:function(){e=!0},locked:function(){return!!e},unlock:function(){e=a=d=c=f=l=void 0}}}function w(b,e){var a={reconnect:function(a){return 2*(a||250)},transports:[D,E,F]};if(e)for(var d in e)a[d]=e[d];e=a;var c={},f={};c.on=function(a,b){var c;c=f[a];if(!c){if(f.message.locked())return this;
c=f[a]=m();c.order=f.message.order}c.add(b);return this};c.off=function(a,b){var c=f[a];c&&c.remove(b);return this};c.once=function(a,b){function e(){c.off(a,e);b.apply(c,arguments)}b.guid=b.guid||v++;e.guid=b.guid;return c.on(a,e)};c.fire=function(a){var b=f[a];b&&b.fire(c,B.call(arguments,1));return this};var l,r,h,p;c.open=function(){n="preparing";l=null;clearTimeout(r);p&&p++;for(var a in f)f[a].unlock();return c.fire("connecting")};c.close=function(){e.reconnect=!1;clearTimeout(r);l?l.close():
c.fire("close");return this};var n;c.state=function(){return n};for(d in{connecting:1,open:1,close:1,waiting:1})f[d]=m(!0),f[d].order=v++;f.message=m(!1);f.message.order=f.open.order;c.on("connecting",function(){n="connecting";for(var a=g.isArray(b)?B.call(b):[b],d=0;d<a.length;d++){var f=a[d]=g.makeAbsolute(a[d]);/^https?:/.test(f)&&!g.parseURI(f).query.transport&&a.splice(d,1,f.replace(/^http/,"ws"),g.stringifyURI(f,{transport:"stream"}),g.stringifyURI(f,{transport:"longpoll"}))}(function x(){function b(){f.off("close",
x).close()}var d=a.shift();if(d){for(var f,t=0;t<e.transports.length&&!(f=e.transports[t](d,e));t++);f?(c.once("close",b),f.open().on("close",x).on("text",function L(a){f.off("text",L);a=g.parseURI(a).query;e.heartbeat=+a.heartbeat;e._heartbeat=+a._heartbeat||5E3;l=f.off("close",x);var d;l.on("text",function(a){if(d){var b=g.parseJSON(a),f;a=function(a){return function(d){f||(f=!0,c.send("reply",{id:b.id,data:d,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];c.fire.apply(c,
a)}else d=!0}).on("error",function(a){c.fire("error",a)}).on("close",function(){c.fire("close")});c.off("close",b).fire("open")})):x()}else c.fire("error",Error()).fire("close")})()}).on("open",function(){n="opened";var a;(function K(){a=setTimeout(function(){c.send("heartbeat").once("heartbeat",function(){clearTimeout(a);K()});a=setTimeout(function(){c.fire("error",Error("heartbeat"));l.close()},e._heartbeat)},e.heartbeat-e._heartbeat)})();c.once("close",function(){clearTimeout(a)});f.connecting.lock();
r=h=p=null}).on("close",function(){n="closed";for(var a in f){var b=f[a];b.order<f.close.order&&b.lock()}if(e.reconnect)c.once("close",function(){p=p||1;h=e.reconnect.call(c,h,p);!1!==h&&(r=setTimeout(function(){c.open()},h),c.fire("waiting",h,p))})}).on("waiting",function(){n="waiting"});var t={};c.send=function(a,b,d,f){if("opened"!==n)return c.fire(Error("notopened")),this;a={id:v++,type:a,data:b,reply:!(!d&&!f)};a.reply&&(t[a.id]=[d,f]);l.send(g.stringifyJSON(a));return this};c.on("reply",function(a){t[a.id][+a.exception].call(c,
a.data);delete t[a.id]});return c.open()}function G(b,e){var a=e&&e.timeout||3E3,d={open:function(){function b(){clearTimeout(f)}d.connect();var f=setTimeout(function(){d.fire("error",Error("timeout")).close()},a);d.on("open",b).on("close",b);return this}},c={open:m(!0),text:m(),binary:m(),error:m(),close:m(!0)};d.on=function(a,b){c[a].add(b);return this};d.off=function(a,b){c[a].remove(b);return this};d.fire=function(a){c[a].fire(d,B.call(arguments,1));return this};var f=!1;d.on("open",function(){f=
!0});d.on("close",function(){f=!1;for(var a in c)"close"!==a&&c[a].lock()});d.send=function(a){f?d.write(a):d.emit("error",Error("notopened"));return this};return d}function D(b,e){var a=h.WebSocket;if(a&&/^wss?:/.test(b)){var d,c=G(b,e);c.connect=function(){d=new a(b);d.binaryType="arraybuffer";d.onopen=function(){c.fire("open")};d.onmessage=function(a){"string"===typeof a.data?c.fire("text",a.data):c.fire("binary",a.data)};d.onerror=function(){c.fire("error",Error()).fire("close")};d.onclose=function(){c.fire("close")}};
c.write=function(a){d.send(a)};c.close=function(){d.close();return this};return c}}function H(b,e){var a=e&&e.xdrURL,d=G(b,e),c;d.on("open",function(){c=g.stringifyURI(b,{id:d.id})}).on("close",function(){c=null});var f=!1,l=[],r=function(){l.length?p(l.shift()):f=!1},m=function(){c&&d.fire("error",Error()).close()},p=!g.crossOrigin(b)||g.corsable?function(a){var b=g.createXMLHttpRequest();b.onreadystatechange=function(){4===b.readyState&&(200===b.status?r():m())};b.open("POST",c);g.corsable&&(b.withCredentials=
!0);"string"===typeof a?(b.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),b.send("data="+a)):(b.setRequestHeader("Content-Type","application/octet-stream"),b.send(a));return this}:h.XDomainRequest&&a?function(b){var f=new h.XDomainRequest;f.onload=r;f.onerror=m;f.open("POST",a.call(d,c));f.send("data="+b);return this}:function(a){var b=q.createElement("form");b.action=c;b.target="socket-"+v++;b.method="POST";b.enctype=b.encoding="text/plain";b.acceptCharset="UTF-8";b.style.display="none";
b.innerHTML='<textarea name="data"></textarea><iframe name="'+b.target+'"></iframe>';b.firstChild.value=a;a=b.lastChild;g.on(a,"error",function(){m()});g.on(a,"load",function(){q.body.removeChild(b);r()});q.body.appendChild(b);b.submit();return this};d.write=function(a){f?l.push(a):(f=!0,p(a))};var n;d.close=function(){d.abort();if(!n){n=!0;var a=q.createElement("script");a.async=!1;a.src=g.stringifyURI(b,{id:d.id,when:"abort"});a.onload=a.onerror=a.onreadystatechange=function(){if(!a.readyState||
/loaded|complete/.test(a.readyState))a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),d.fire("close")};y.insertBefore(a,y.firstChild)}return this};return d}function E(b,e){if(/^https?:/.test(b)&&"stream"===g.parseURI(b).query.transport)return M(b,e)||N(b,e)||O(b,e)||P(b,e)}function z(b,e){var a="",d=H(b,e);d.parse=function(b){if(b=b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var c=0;c<b.length-1;c++)d.onmessage(b[c].substring(6));a=b[b.length-1]}};var c;d.onmessage=
function(a){if(c){var b=a.substring(0,1);a=a.substring(1);switch(b){case "1":d.fire("text",a);break;case "2":if("object"===typeof exports)a=new Buffer(a,"base64");else{b=atob(a);a=new Uint8Array(a.length);for(var e=0;e<b.length;e++)a[e]=b.charCodeAt(e);a=a.buffer}d.fire("binary",a)}}else c=!0,b=g.parseURI(a).query,d.id=b.id,d.fire("open")};return d}function M(b,e){var a=h.EventSource;if(a&&!(g.crossOrigin(b)&&g.browser.safari&&7>g.browser.vmajor)){var d,c=z(b,e);c.connect=function(){d=new a(b+"&when=open&sse=true",
{withCredentials:!0});d.onmessage=function(a){c.onmessage(a.data)};d.onerror=function(){d.close();c.fire("close")}};c.abort=function(){d.close()};return c}}function N(b,e){if(!(g.browser.msie&&10>g.browser.vmajor||g.crossOrigin(b)&&!g.corsable)){var a,d=z(b,e);d.connect=function(){var c;a=g.createXMLHttpRequest();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d.parse(c?a.responseText.substring(c):a.responseText),c=a.responseText.length):4===a.readyState&&(200!==a.status&&d.fire("error",
Error()),d.fire("close"))};a.open("GET",b+"&when=open");g.corsable&&(a.withCredentials=!0);a.send()};d.abort=function(){a.abort()};return d}}function O(b,e){var a=e&&e.xdrURL,d=h.XDomainRequest;if(a&&d){var c,f=z(b,e);f.connect=function(){var e;c=new d;c.onprogress=function(){f.parse(e?c.responseText.substring(e):c.responseText);e=c.responseText.length};c.onerror=function(){f.fire("error",Error()).fire("close")};c.onload=function(){f.fire("close")};c.open("GET",a.call(f,b+"&when=open"));c.send()};
f.abort=function(){c.abort()};return f}}function P(b,e){var a=h.ActiveXObject;if(a&&!g.crossOrigin(b)){var d,c,f=z(b,e);f.connect=function(){function e(a){var b;(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}d=new a("htmlfile");d.open();d.close();var g=d.createElement("iframe");g.src=b+"&when=open";d.body.appendChild(g);var h=g.contentDocument||g.contentWindow.document;c=e(function(){function a(){var c=b.cloneNode(!0);c.appendChild(h.createTextNode("."));
c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(h.firstChild){var b=h.body.lastChild;if(!b)return f.fire("error",Error()).fire("close"),!1;f.parse(a());b.innerText="";c=e(function(){var c=a();c&&(b.innerText="",f.parse(c));if("complete"===h.readyState)return f.fire("close"),!1});return!1}})};f.abort=function(){c();d.execCommand("Stop")};return f}}function F(b,e){if(/^https?:/.test(b)&&"longpoll"===g.parseURI(b).query.transport)return Q(b,e)||R(b,e)||S(b,e)}function C(b,e){var a=
H(b,e);a.connect=function(){a.poll(b+"&when=open",function(d){d=g.parseURI(d).query;a.id=d.id;(function f(){a.poll(g.stringifyURI(b,{id:a.id,when:"poll"}),function(b){b?(f(),"string"===typeof b?a.fire("text",b):a.fire("binary",b)):a.fire("close")})})();a.fire("open")})};return a}function Q(b,e){if(!g.crossOrigin(b)||g.corsable){var a,d=C(b,e);d.poll=function(b,e){a=g.createXMLHttpRequest();a.onreadystatechange=function(){switch(a.readyState){case 2:"application/octet-stream"===a.getResponseHeader("content-type")&&
(a.responseType="arraybuffer");break;case 4:200===a.status?e(a.response||a.responseText):d.fire("error",Error()).fire("close")}};a.open("GET",b);g.corsable&&(a.withCredentials=!0);a.send(null)};d.abort=function(){a.abort()};return d}}function R(b,e){var a=e&&e.xdrURL,d=h.XDomainRequest;if(a&&d){var c,f=C(b,e);f.poll=function(b,e){b=a.call(f,b);c=new d;c.onload=function(){e(c.responseText)};c.onerror=function(){f.fire("error",Error()).fire("close")};c.open("GET",b);c.send()};f.abort=function(){c.abort()};
return f}}function S(b,e){var a,d=C(b,e),c=I.pop()||"socket_"+v++;h[c]=function(b){a.responseText=b};d.on("close",function(){h[c]=function(){};I.push(c)});d.poll=function(b,e){a=q.createElement("script");a.async=!0;a.src=g.stringifyURI(b,{jsonp:"true",callback:c});a.clean=function(){a.clean=a.onerror=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&(a.clean&&a.clean(),e(a.responseText),a.responseText=
null)};a.onerror=function(){a.clean();d.fire("error",Error()).fire("close")};y.insertBefore(a,y.firstChild)};d.abort=function(){a.clean&&a.clean()};return d}var v=1,B=Array.prototype.slice,J=Object.prototype.toString,T=Object.prototype.hasOwnProperty,q=h.document,A=h.location,U=h.navigator,y=q.head||q.getElementsByTagName("head")[0]||q.documentElement,g={};g.isArray=Array.isArray||function(b){return"[object Array]"===J.call(b)};g.makeAbsolute=function(b){var e=q.createElement("div");e.innerHTML='<a href="'+
b+'"/>';return encodeURI(decodeURI(e.firstChild.href))};g.on=function(b,e,a){b.addEventListener?b.addEventListener(e,a,!1):b.attachEvent&&b.attachEvent("on"+e,a)};g.stringifyURI=function(b,e){var a,d=[];e=e||{};e._=v++;for(a in e)null!=e[a]&&d.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return b+(/\?/.test(b)?"&":"?")+d.join("&").replace(/%20/g,"+")};g.parseURI=function(b){var e={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var d=b[a].split("=");
e.query[decodeURIComponent(d[0])]=decodeURIComponent(d[1]||"")}}return e};g.createXMLHttpRequest=function(){try{return new h.XMLHttpRequest}catch(b){try{return new h.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}};g.parseJSON=h.JSON?h.JSON.parse:function(b){return Function("return "+b)()};g.stringifyJSON=h.JSON?h.JSON.stringify:function(b){function e(a){return'"'+a.replace(d,function(a){var b=c[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>
a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function l(b,c){var d,g,h,k=c[b];h=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(b),h=typeof k);switch(h){case "string":return e(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";
switch(J.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":g=k.length;h=[];for(d=0;d<g;d++)h.push(l(d,k)||"null");return"["+h.join(",")+"]";default:h=[];for(d in k)T.call(k,d)&&(g=l(d,k))&&h.push(e(d)+":"+g);return"{"+h.join(",")+"}"}}}("",{"":b})};g.corsable="withCredentials"in g.createXMLHttpRequest();g.browser=
function(){var b=U.userAgent.toLowerCase(),e={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");e[b[1]||""]=!0;e.version=b[2]||"0";e.vmajor=e.version.split(".")[0];e.trident&&(e.msie=!0);return e}();g.crossOrigin=function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());return!(!b||b[1]==A.protocol&&b[2]==A.hostname&&(b[3]||("http:"===b[1]?80:443))==
(A.port||("http:"===A.protocol?80:443)))};var I=[],u=[];g.on(h,"unload",function(){for(var b,e=0;e<u.length;e++)b=u[e],"closed"!==b.state()&&b.close()});g.on(h,"online",function(){for(var b,e=0;e<u.length;e++)b=u[e],"waiting"===b.state()&&b.open()});g.on(h,"offline",function(){for(var b,e=0;e<u.length;e++)b=u[e],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return{open:function(b,e){var a=w(b,e);u.push(a);return a},transport:{createWebSocketTransport:D,createHttpStreamTransport:E,
createHttpLongpollTransport:F},util:g}});